input {
  file {
    path => "/var/log/**/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => "plain"
  }
}

filter {
  # Parse nginx access logs
  if [path] =~ "nginx" {
    grok {
      match => { "message" => "%{NGINXACCESS}" }
    }
    mutate {
      add_field => { "log_source" => "nginx" }
    }
  }
  
  # Parse apache access logs
  else if [path] =~ "apache" {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    mutate {
      add_field => { "log_source" => "apache" }
    }
  }
  
  # Parse any common log format
  else {
    grok {
      match => { "message" => "%{COMBINEDAPACHELOG}" }
    }
    mutate {
      add_field => { "log_source" => "web" }
    }
  }
  
  # Convert response code to number
  if [response] {
    mutate {
      convert => { "response" => "integer" }
    }
  }
  
  # Convert bytes to number
  if [bytes] and [bytes] != "-" {
    mutate {
      convert => { "bytes" => "integer" }
    }
  }
  
  # Add response category
  if [response] {
    if [response] >= 200 and [response] < 300 {
      mutate { add_field => { "response_category" => "success" } }
    }
    else if [response] >= 300 and [response] < 400 {
      mutate { add_field => { "response_category" => "redirect" } }
    }
    else if [response] >= 400 and [response] < 500 {
      mutate { add_field => { "response_category" => "client_error" } }
    }
    else if [response] >= 500 {
      mutate { add_field => { "response_category" => "server_error" } }
    }
  }
}

output {
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "web-logs-%{+YYYY.MM.dd}"
  }
  
  stdout {
    codec => rubydebug
  }
}
